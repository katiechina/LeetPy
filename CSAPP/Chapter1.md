# 深入理解计算机系统（1）

- 深度参考 Datawhale CSAPP教程

## 一、 程序的执行
在计算机系统中， 一个程序的执行涉及到多个步骤，大致可分为4个阶段。
预处理 --> 编译 --> 汇编 --> 链接


- 1 预处理器会读取该头文件中的内容，将其中的内容直接插入到源程序中

- 2 编译包括词法分析、语法分析、语义分析、中间代码生成以及优化等等一系列的中间操作

- 3 汇编器根据指令集将汇编程序翻译成机器指令，并且把这一系列的机器指令按照固定的规则进行打包，得到可重定位目标文件。此时，该文件虽然是一个二进制的文件，但是还不能执行

- 4 链接器 (ld）负责把3中的生成的文件和调用的调用的标准库中的函数 按照一定规则进行合并，经过链接阶段可以得到可执行目标文件

## 二、硬件架构

1. CPU
中央处理单元(Central Processing Unit , CPU)，也称处理器，包含以下三个部分：
程序计数器 PC -- 4字节（32位机器）或8字节（64位机器），存放指令地址
寄存器 -- 临时存放数据的空间（速度快，容量小）
算数/逻辑计算单元 ALU -- 速度极快，计算机核心部分

2. 内存
主存(Main Memory)，也称为内存、运行内存，处理器在执行程序时，内存主要存放程序指令以及数据。
物理上讲 -- 随机动态存储器芯片组成
逻辑上讲 -- 一个从零开始的大数组，每个字节都有相应地址.

3. 总线
内存和处理器之间通过总线来进行数据传递。

4. 输入输出设备
每一个输入输出设备都通过一个控制器或者适配器与 IO 总线相连.


## 三、 程序执行流程
1. 键盘输入字符串"/.hello" -- shell程序将字符串读入寄存器 -- 处理器把字符串放入内存
2. 键盘输入回车键 -- shell程序知道我们已经完成了命令的输入 -- shell执行一系列的指令来来加载可执行文件 hello
3. 这些指令将 hello 中的数据和代码从磁盘复制到内存，利用 DMA(Direct Memory Access) 技术，数据可以不经过处理器，从磁盘直接到达内存
4. 可执行文件 hello 中的代码和数据被加载到内存中 -- 处理器就开始执行 main 函数中的代码


## 四、缓存技术
针对处理器和内存之间的差异，系统设计人员在寄存器文件和内存之间引入了高速缓存(cache)， 比较新的，处理能力比较强的处理器，一般有三级高速缓存，分别为 L1 cache ，L2 cache 以及 L3 cache。

整个计算机系统的信息存储可以用一个层次结构来表示，通常而言，存储容量越小， 速度越快，价格越高，上一层存储设备是下一层存储设备的高速缓存.

如寄存器是L1 cache的高速缓存，内存是磁盘的高速缓存。

## 五、操作系统

1. 无论是 shell 程序还是 hello 程序都没有直接访问键盘、显示器、磁盘这些硬件设备，真正操作硬件的是操作系统，我们可以把操作系统看成是应用程序和硬件之间的中间层，所有的应用程序对硬件的操作必须通过操作系统来完成。

应用程序 <-->  操作系统 <--> 硬件设备

文件 -- IO 设备的 抽象
虚拟内存 -- 内存和磁盘 IO 的抽象
进程 -- 处理器、内存以及 IO 设备的抽象

2. 进程与线程
shell进程运行  -- 系统调用（保留shell上下文）-- 创建hello进程和上下文 -- hello运行 -- hello运行结束 -- 系统调用（恢复shell进程上下文）-- shell进程运行

一个进程实际上由多个线程组成，每个线程都运行在进程的上下文中，共享代码和数据。
例子：
一个微信程序就是一个进程，而我们在微信里一边文字聊天、一边视频聊天、 一边传输文件就是三个线程同时进行。

3. 虚拟内存
地址从0开始不断增大：
程序的代码和数据  -- 读写数据区域（全局变量）-- 堆(heap)可以在运行时动态的扩展和收缩 -- 共享库的存放区域 -- 用户栈(user stack)，函数调用的本质就是压栈，栈的增长方向是从高地址到低地址 -- 内核保留的区域，对应用程序不可见

## 六、并行与加速比相关定律
阿姆达尔定律(Amdahl’s Law, 1967)
记 α ∈ [0, 1] 是某任务无法并行处理部分所占的比例. 假设该任务的工作量固定，则对任意 n 个处理器，相比于 1 个处理器，能够取得的加速比满足:S(n) < α1 

古斯塔法森定律 (Gustafson’s Law, 1988)
记 α ∈ [0, 1] 是某任务无法并行处理部分所占的比例. 假设该任务的工作量可以随着处理器个数缩放，从而保持处理时间固定. 则对任意 n 个处理器，相比于 1 个处理 器，能够取得的加速比 S (n) 不存在上界.

## 七、并发和并行
1. 线程级并发
单颗芯片集成多个CPU

超线程(hyperthreading)，也称同时多线程
- 在 CPU 内部，像程序计数器和寄存器文件这样的硬件部件有多个备份，而像浮点 运算部件这个样的硬件还是只有一份，常规单线程处理器在做线程切换时，大概需 要 20000 个时钟周期，而超线程处理器可以在单周期的基础上决定执行哪一个线程， 这样一来，CPU 可以更好地利用它的处理资源。当一个线程因为读取数据而进入等 待状态时，CPU 可以去执行另外一个线程，其中线程之间的切换只需要极少的时间 代价.

2. 指令级并行
同时执行多条指令的属性称为指令级并行，每条指令从开始到结束大概需要 20 个时钟周期或者更多，但是处理器采用了非常多的技巧可以同时处理多达 100 条指命

3. 单指令多数据并行
现代处理器拥有特殊的硬件部件，允许一条指令产生多个并行的操作，这种方式称 为单指令多数据(Single Instruction Multiple Data)。SIMD 的指令多是为了提高处 理视频、以及声音这类数据的执行速度。

